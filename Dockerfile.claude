# Stage 1: Build Go tools with CGO disabled for static binaries.
FROM golang:1.25.6-alpine AS go-tools

ARG MAGE_VERSION=1.15.0
ARG GOLANGCI_LINT_VERSION=2.1.6

ENV CGO_ENABLED=0
RUN go install github.com/magefile/mage@v${MAGE_VERSION} && \
    go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v${GOLANGCI_LINT_VERSION}

# Stage 2: Final image.
FROM node:20-alpine

ARG CLAUDE_CODE_VERSION=latest

RUN apk add --no-cache git bash

# Non-root user (Claude Code refuses --dangerously-skip-permissions as root).
RUN addgroup -S crumbs && adduser -S crumbs -G crumbs

# Go runtime copied from the official image (no download step).
COPY --from=golang:1.25.6-alpine /usr/local/go /usr/local/go
ENV PATH="/usr/local/go/bin:/home/crumbs/go/bin:${PATH}"
ENV GOPATH="/home/crumbs/go"

# Compiled tool binaries from the builder stage.
COPY --from=go-tools /go/bin/mage /home/crumbs/go/bin/
COPY --from=go-tools /go/bin/golangci-lint /home/crumbs/go/bin/

# Claude Code.
RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION} && \
    npm cache clean --force

RUN mkdir -p /home/crumbs/.claude && chown -R crumbs:crumbs /home/crumbs

WORKDIR /workspace
USER crumbs
