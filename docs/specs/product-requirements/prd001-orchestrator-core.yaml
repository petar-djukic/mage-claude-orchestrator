id: prd001-orchestrator-core
title: Orchestrator Core Interface

problem: |
  Consuming projects need a stable entry point to configure and use
  the orchestrator. Without a well-defined Config struct and constructor,
  each project would handle initialization differently, leading to
  inconsistent defaults and fragile wiring between Mage targets and
  orchestrator methods. Configuration must be reproducible: a developer
  should know exactly what options a generation used by inspecting a
  single YAML file.

goals:
  - G1: Define a Config struct that covers all project and execution settings
  - G2: Provide a constructor that applies sensible defaults to zero-value fields
  - G3: Define the Orchestrator struct as the single entry point for all operations
  - G4: Provide YAML-based configuration loading from a configuration.yaml file
  - G5: Provide initialization and reset operations for the project

requirements:
  R1:
    title: Config Struct
    items:
      - R1.1: Config must include ModulePath (string) for the Go module path
      - R1.2: Config must include BinaryName (string) for the compiled binary name
      - R1.3: Config must include BinaryDir (string, default "bin") for binary output
      - R1.4: Config must include MainPackage (string) for the main.go entry point path
      - R1.5: Config must include GoSourceDirs ([]string) listing directories with Go source
      - R1.6: Config must include VersionFile (string) for the version.go path
      - R1.7: Config must include GenPrefix (string, default "generation-") for generation branch names
      - R1.8: Config must include BeadsDir (string, default ".beads/") for the issue tracker directory
      - R1.9: Config must include CobblerDir (string, default ".cobbler/") for the scratch directory
      - R1.10: Config must include MagefilesDir (string, default "magefiles") for the directory skipped during Go file deletion
      - R1.11: Config must include SecretsDir (string, default ".secrets") for token files
      - R1.12: Config must include DefaultTokenFile (string, default "claude.json") for the credential filename
      - R1.13: Config must include SpecGlobs (map[string]string) for documentation word-count globs
      - R1.14: Config must include SeedFiles (map[string]string) mapping destination paths to template source file paths
      - R1.15: Config must include MeasurePrompt (string) as a file path to a custom measure prompt template
      - R1.16: Config must include StitchPrompt (string) as a file path to a custom stitch prompt template
      - R1.17: Config must include ClaudeArgs ([]string) for CLI arguments passed to the claude binary
      - R1.18: Config must include SilenceAgent (*bool, default true) to suppress Claude stdout
      - R1.19: Config must include MaxIssues (int, default 10) for the task limit per phase
      - R1.20: Config must include Cycles (int, default 1) for the number of measure+stitch cycles per run
      - R1.21: Config must include UserPrompt (string) for additional context in the measure prompt
      - R1.22: Config must include GenerationBranch (string) for explicit branch selection
      - R1.23: Config must include TokenFile (string) for a credential file override in SecretsDir
      - R1.24: All Config fields must have YAML struct tags using snake_case names
      - R1.25: Config must include EstimatedLinesMin (int, default 250) for the minimum estimated lines per task
      - R1.26: Config must include EstimatedLinesMax (int, default 350) for the maximum estimated lines per task
      - R1.27: Config must include CleanupDirs ([]string) listing directories to remove after generation stop or reset
      - R1.28: Config must include PodmanImage (string, required) for the container image used for Claude execution
      - R1.29: Config must include PodmanArgs ([]string) for additional arguments passed to podman run
      - R1.30: Config must include ClaudeMaxTimeSec (int, default 300) for the maximum seconds per Claude invocation

  R2:
    title: Constructor and Defaults
    items:
      - R2.1: New(Config) must return an *Orchestrator with defaults applied to zero-value fields
      - R2.2: applyDefaults must set BinaryDir to "bin" when empty
      - R2.3: applyDefaults must set GenPrefix to "generation-" when empty
      - R2.4: applyDefaults must set BeadsDir to ".beads/" when empty
      - R2.5: applyDefaults must set CobblerDir to ".cobbler/" when empty
      - R2.6: applyDefaults must set MagefilesDir to "magefiles" when empty
      - R2.7: applyDefaults must set SecretsDir to ".secrets" when empty
      - R2.8: applyDefaults must set DefaultTokenFile to "claude.json" when empty
      - R2.9: applyDefaults must set ClaudeArgs to defaultClaudeArgs when empty
      - R2.10: applyDefaults must set MaxIssues to 10 when zero
      - R2.11: Cycles defaults to 0 (unlimited); acts as a safety limit when positive
      - R2.12: applyDefaults must set EstimatedLinesMin to 250 when zero
      - R2.13: applyDefaults must set EstimatedLinesMax to 350 when zero
      - R2.14: applyDefaults must set ClaudeMaxTimeSec to 300 when zero

  R3:
    title: Logging
    items:
      - R3.1: logf must print timestamped messages to stderr in RFC3339 format
      - R3.2: When a generation is active, logf must include the generation name after the timestamp
      - R3.3: setGeneration and clearGeneration must control the generation tag in log output

  R4:
    title: YAML Configuration Loading
    items:
      - R4.1: LoadConfig(path) must read and parse a YAML file into a Config struct
      - R4.2: LoadConfig must resolve SeedFiles values by reading each template source file and replacing the map value with its content
      - R4.3: LoadConfig must resolve MeasurePrompt and StitchPrompt by reading the referenced files when non-empty
      - R4.4: LoadConfig must call applyDefaults after parsing
      - R4.5: NewFromFile(path) must call LoadConfig and then New to return a configured Orchestrator
      - R4.6: "SilenceAgent must use *bool to distinguish \"not set in YAML\" (nil, defaults to true) from \"explicitly set to false\""
      - R4.7: Config.Silence() must return true when SilenceAgent is nil, otherwise return the pointed-to value
      - R4.8: Config.EffectiveTokenFile() must return TokenFile if set, otherwise DefaultTokenFile

  R5:
    title: Initialization and Reset
    items:
      - R5.1: Init must initialize the beads issue tracker
      - R5.2: FullReset must reset cobbler, generator, and beads in sequence
      - R5.3: BeadsInit must create the beads database directory
      - R5.4: BeadsReset must remove and reinitialize the beads database

  R6:
    title: Seed Files
    items:
      - R6.1: SeedData must provide Version (string) and ModulePath (string) as template data
      - R6.2: seedFiles must create files from SeedFiles templates, creating parent directories as needed
      - R6.3: seedFiles must execute templates with SeedData containing the generation name as Version

non_goals:
  - This PRD does not define the generation lifecycle (see prd002)
  - This PRD does not define measure or stitch workflows (see prd003)
  - This PRD does not define metrics collection (see prd005)

acceptance_criteria:
  - Config struct includes all fields listed in R1 with YAML struct tags
  - New() returns a configured Orchestrator with defaults applied
  - NewFromFile() reads YAML and returns a configured Orchestrator
  - LoadConfig resolves seed file paths and prompt file paths to content
  - logf produces timestamped output with optional generation tag
  - Init and FullReset operate without errors on a clean repository
  - Seed files are created from templates with correct data
