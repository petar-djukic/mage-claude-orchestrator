id: prd003-cobbler-workflows
title: Cobbler Measure and Stitch Workflows

problem: |
  Turning project specifications into working code requires two distinct
  capabilities: analyzing what needs to be built and executing individual
  tasks. Without structured workflows for these phases, the orchestrator
  cannot decompose work into manageable pieces or execute them with
  proper isolation, metrics tracking, and error recovery.

goals:
  - G1: Define the measure workflow that proposes tasks from project state
  - G2: Define the stitch workflow that executes tasks in isolated worktrees
  - G3: Support configurable Claude invocation parameters
  - G4: Record invocation metrics for every Claude session
  - G5: Handle task dependencies and lifecycle through beads integration

requirements:
  R1:
    title: Workflow Configuration
    items:
      - R1.1: Measure and stitch must read SilenceAgent, MaxIssues, UserPrompt, GenerationBranch, and TokenFile from Config (see prd001 R1.17-R1.23)
      - R1.2: Measure and stitch must read ClaudeArgs from Config for Claude invocation arguments
      - R1.3: RunMeasure and RunStitch must take no parameters; all options come from Config

  R2:
    title: Measure Workflow
    items:
      - R2.1: Measure must verify beads is initialized before proceeding
      - R2.2: Measure must resolve and switch to the target branch
      - R2.3: Measure must query existing issues from beads via bd list
      - R2.4: Measure must clean up old proposed-issues files from the cobbler directory
      - R2.5: Measure must build the prompt from the template with existing issues, limit, output path, and user input
      - R2.6: Measure must invoke Claude with the built prompt
      - R2.7: Measure must parse the JSON output file written by Claude
      - R2.8: Measure must import proposed issues into beads with title and description
      - R2.9: Measure must wire dependencies between imported issues based on the dependency index
      - R2.10: Measure must record an InvocationRecord on each created issue
      - R2.11: Measure must commit beads changes after import

  R3:
    title: Stitch Workflow
    items:
      - R3.1: Stitch must verify beads is initialized before proceeding
      - R3.2: Stitch must resolve and switch to the target branch
      - R3.3: Stitch must recover stale tasks from interrupted runs before processing
      - R3.4: Stitch must pick ready tasks one at a time from beads (bd ready -n 1 --type task)
      - R3.5: Stitch must stop when no ready tasks remain or MaxIssues is reached
      - R3.6: For each task, stitch must claim the task by setting status to in_progress
      - R3.7: For each task, stitch must create a git worktree on a task branch
      - R3.8: Task branches must follow the pattern task/{baseBranch}-{issueID}
      - R3.9: For each task, stitch must capture LOC before Claude
      - R3.10: For each task, stitch must build the prompt from the template with task data
      - R3.11: For each task, stitch must invoke Claude in the worktree directory
      - R3.12: For each task, stitch must merge the task branch back to the base branch
      - R3.13: For each task, stitch must capture LOC after Claude and git diff stats
      - R3.14: For each task, stitch must clean up the worktree and delete the task branch
      - R3.15: For each task, stitch must record an InvocationRecord and close the task

  R4:
    title: Recovery
    items:
      - R4.1: recoverStaleTasks must scan for stale task branches matching the pattern
      - R4.2: recoverStaleTasks must remove orphaned worktrees and delete stale branches
      - R4.3: recoverStaleTasks must reset affected issues to ready status
      - R4.4: resetOrphanedIssues must find in_progress issues without corresponding task branches
      - R4.5: resetOrphanedIssues must reset orphaned issues to ready status
      - R4.6: Recovery must commit beads changes if any state was recovered

  R5:
    title: Prompt Templates
    items:
      - R5.1: Default measure template must be embedded via go:embed from prompts/measure.tmpl
      - R5.2: Default stitch template must be embedded via go:embed from prompts/stitch.tmpl
      - R5.3: Custom templates from Config must override the embedded defaults
      - R5.4: MeasurePromptData must provide ExistingIssues, Limit, OutputPath, and UserInput
      - R5.5: StitchPromptData must provide Title, ID, IssueType, and Description
      - R5.6: MeasurePromptData must provide LinesMin and LinesMax from Config.EstimatedLinesMin and Config.EstimatedLinesMax

  R6:
    title: Claude Invocation
    items:
      - R6.1: runClaude must execute the claude binary inside a podman container with the prompt on stdin
      - R6.2: runClaude must mount the working directory into the container at the same path using -v mountDir:mountDir
      - R6.3: runClaude must set the container working directory using podman -w when a worktree path is provided
      - R6.4: runClaude must capture stdout for token parsing
      - R6.5: parseClaudeTokens must extract input and output token counts from stream-json output
      - R6.6: When silence is false, Claude stdout must be tee'd to both buffer and os.Stdout
      - R6.7: runClaude must pass Config.PodmanArgs before the image name and Config.ClaudeArgs after the claude binary
      - R6.8: runClaude must use context.WithTimeout to enforce ClaudeMaxTimeSec; process is killed on expiry
      - R6.9: runClaude must clear Claude history files ($HOME/.claude.json*) before each invocation
      - R6.10: On Claude failure or timeout in stitch, the task must be reset to ready and the worktree cleaned up
      - R6.11: On merge failure in stitch, the task must be reset to ready and the worktree cleaned up

  R7:
    title: Issue Import
    items:
      - R7.1: proposedIssue must include index (int), title (string), description (string), and dependency (int)
      - R7.2: importIssues must create tasks in beads for each proposed issue
      - R7.3: importIssues must wire dependencies using bd dep add for issues with dependency >= 0
      - R7.4: importIssues must commit beads changes after successful import

  R8:
    title: Pre-flight Checks
    items:
      - R8.1: checkPodman must verify Config.PodmanImage is not empty
      - R8.2: checkPodman must verify the podman binary is on PATH
      - R8.3: checkPodman must verify a container can start using the configured PodmanImage
      - R8.4: checkPodman must return an error with a README reference when any check fails
      - R8.5: RunMeasure must call checkPodman before any other work
      - R8.6: RunStitch must call checkPodman before any other work

non_goals:
  - This PRD does not define the generation lifecycle (see prd002)
  - This PRD does not define the prompt content or Claude behavior expectations
  - This PRD does not define concurrent task execution (tasks run sequentially)

acceptance_criteria:
  - Measure proposes tasks from project state and imports them into beads
  - Stitch executes ready tasks in isolated worktrees and merges results
  - Recovery resets stale tasks and orphaned issues to ready
  - Invocation records are stored on every task with token and LOC data
  - Custom prompt templates override embedded defaults
