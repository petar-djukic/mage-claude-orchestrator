id: prd003-cobbler-workflows
title: Cobbler Measure and Stitch Workflows

problem: |
  Turning project specifications into working code requires two distinct
  capabilities: analyzing what needs to be built and executing individual
  tasks. Without structured workflows for these phases, the orchestrator
  cannot decompose work into manageable pieces or execute them with
  proper isolation, metrics tracking, and error recovery.

goals:
  - G1: Define the measure workflow that proposes tasks from project state
  - G2: Define the stitch workflow that executes tasks in isolated worktrees
  - G3: Support configurable Claude invocation parameters
  - G4: Record invocation metrics for every Claude session
  - G5: Handle task dependencies and lifecycle through beads integration

requirements:
  R1:
    title: Workflow Configuration
    items:
      - R1.1: Measure and stitch must read SilenceAgent, MaxStitchIssuesPerCycle, MaxMeasureIssues, UserPrompt, GenerationBranch, and TokenFile from Config (see prd001 R1.16-R1.23)
      - R1.2: Measure and stitch must read ClaudeArgs from Config for Claude invocation arguments
      - R1.3: RunMeasure and RunStitch must take no parameters; all options come from Config

  R2:
    title: Measure Workflow
    items:
      - R2.1: Measure must verify beads is initialized before proceeding
      - R2.2: Measure must resolve and switch to the target branch
      - R2.3: Measure must query existing issues from beads via bd list
      - R2.4: Measure must clean up old proposed-issues files from the cobbler directory
      - R2.5: Measure must build the prompt from the template with existing issues, limit, output path, and user input
      - R2.6: Measure must invoke Claude with the built prompt
      - R2.7: Measure must parse the YAML output file written by Claude
      - R2.8: Measure must import proposed issues into beads with title and description
      - R2.9: Measure must wire dependencies between imported issues based on the dependency index
      - R2.10: Measure must record an InvocationRecord on each created issue
      - R2.11: Measure must commit beads changes after import

  R3:
    title: Stitch Workflow
    items:
      - R3.1: Stitch must verify beads is initialized before proceeding
      - R3.2: Stitch must resolve and switch to the target branch
      - R3.3: Stitch must recover stale tasks from interrupted runs before processing
      - R3.4: Stitch must pick ready tasks one at a time from beads (bd ready -n 1 --type task)
      - R3.5: Stitch must stop when no ready tasks remain or MaxIssues is reached
      - R3.6: For each task, stitch must claim the task by setting status to in_progress
      - R3.7: For each task, stitch must create a git worktree on a task branch
      - R3.8: Task branches must follow the pattern task/{baseBranch}-{issueID}
      - R3.9: For each task, stitch must capture LOC before Claude
      - R3.10: For each task, stitch must build the prompt from the template with task data
      - R3.11: For each task, stitch must invoke Claude in the worktree directory
      - R3.11a: The orchestrator must stage and commit Claude's changes in the worktree (Claude is forbidden from running git commands)
      - R3.12: For each task, stitch must merge the task branch back to the base branch
      - R3.13: For each task, stitch must capture LOC after Claude and git diff stats
      - R3.14: For each task, stitch must clean up the worktree and delete the task branch
      - R3.15: For each task, stitch must record an InvocationRecord and close the task
      - R3.16: worktreeBasePath must derive the repo name from git rev-parse --git-common-dir so the temp directory for task worktrees is identical whether stitch is invoked from the main repo root or from a git worktree; it must fall back to filepath.Base(os.Getwd()) if git is unavailable

  R4:
    title: Recovery
    items:
      - R4.1: recoverStaleTasks must scan for stale task branches matching the pattern
      - R4.2: recoverStaleTasks must remove orphaned worktrees and delete stale branches
      - R4.3: recoverStaleTasks must reset affected issues to ready status
      - R4.4: resetOrphanedIssues must find in_progress issues without corresponding task branches
      - R4.5: resetOrphanedIssues must reset orphaned issues to ready status
      - R4.6: Recovery must commit beads changes if any state was recovered
      - R4.7: recoverStaleTasks and GeneratorResume must find stale task worktrees regardless of whether they are invoked from the main repo root or from a git worktree of the same repository

  R5:
    title: Prompt Templates
    items:
      - R5.1: Default measure template must be embedded via go:embed from pkg/orchestrator/prompts/measure.tmpl
      - R5.2: Default stitch template must be embedded via go:embed from pkg/orchestrator/prompts/stitch.tmpl
      - R5.3: Custom templates from Config must override the embedded defaults
      - R5.4: MeasurePromptDoc must provide ProjectContext (YAML blob of all docs, specs, source code, and issues), a Task field, Constraints, and OutputFormat assembled from the template and Config
      - R5.5: StitchPromptDoc must provide Title, ID, IssueType, Description, and ProjectContext (built from worktree)
      - R5.6: MeasurePromptDoc must include LinesMin and LinesMax from Config.EstimatedLinesMin and Config.EstimatedLinesMax embedded in the task text
      - R5.7: MeasurePromptDoc must include PlanningConstitution and IssueFormatConstitution (embedded or from Config overrides) as yaml.Node fields
      - R5.8: StitchPromptDoc must include ExecutionConstitution and GoStyleConstitution (embedded or from Config overrides) as yaml.Node fields
      - R5.9: MeasurePromptDoc must include GoldenExample (from Config.Cobbler.GoldenExample) when set, injected into the measure prompt to guide Claude's issue format and granularity

  R6:
    title: Claude Invocation
    items:
      - R6.1: runClaude must execute the claude binary inside a podman container with the prompt on stdin
      - R6.2: runClaude must mount the working directory into the container at the same path using -v mountDir:mountDir
      - R6.3: runClaude must set the container working directory using podman -w when a worktree path is provided
      - R6.4: runClaude must capture stdout for token parsing
      - R6.5: parseClaudeTokens must extract input tokens, output tokens, cache creation tokens, cache read tokens, and cost from stream-json output
      - R6.6: When silence is false, Claude stdout must be tee'd to both buffer and os.Stdout
      - R6.7: runClaude must pass Config.PodmanArgs before the image name and Config.ClaudeArgs after the claude binary
      - R6.8: runClaude must use context.WithTimeout to enforce ClaudeMaxTimeSec; process is killed on expiry
      - R6.10: On Claude failure or timeout in stitch, the task must be reset to ready and the worktree cleaned up
      - R6.11: On merge failure in stitch, the task must be reset to ready and the worktree cleaned up
      - R6.12: runClaude must refresh credentials from macOS Keychain before each invocation
      - R6.13: runClaude must capture RawOutput (full stream-json bytes) for history saving

  R7:
    title: Issue Import and Validation
    items:
      - R7.1: proposedIssue must include index (int), title (string), description (string), and dependency (int)
      - R7.2: importIssues must create tasks in beads for each proposed issue
      - R7.3: importIssues must wire dependencies using bd dep add for issues with dependency >= 0
      - R7.4: importIssues must commit beads changes after successful import
      - R7.5: When Config.Cobbler.MaxRequirementsPerTask is greater than zero, measure must count the number of requirement items in each proposed issue's description and reject issues that exceed the limit; rejected issues must trigger a re-prompt (up to Config.Cobbler.MaxMeasureRetries attempts) instructing Claude to split them into smaller tasks

  R8:
    title: Pre-flight Checks
    items:
      - R8.1: checkPodman must verify Config.PodmanImage is not empty
      - R8.2: checkPodman must verify the podman binary is on PATH
      - R8.3: checkPodman must verify a container can start using the configured PodmanImage
      - R8.4: checkPodman must return an error with a README reference when any check fails
      - R8.5: RunMeasure must call checkPodman before any other work
      - R8.6: RunStitch must call checkPodman before any other work

  R9:
    title: Phase-Specific Context Files
    items:
      - R9.1: The orchestrator must define a PhaseContext struct with include, exclude, sources, and release fields
      - R9.2: loadPhaseContext must read a YAML file at the given path and return a parsed PhaseContext
      - R9.3: loadPhaseContext must return (nil, nil) when the file does not exist
      - R9.4: loadPhaseContext must return an error when the file exists but is malformed
      - R9.5: buildProjectContext must accept an optional *PhaseContext parameter
      - R9.6: When PhaseContext is non-nil, its non-empty fields must override the corresponding ProjectConfig fields
      - R9.7: When PhaseContext is nil, buildProjectContext must use ProjectConfig fields unchanged
      - R9.8: buildMeasurePrompt must load {CobblerConfig.Dir}/measure_context.yaml at invocation time and pass it to buildProjectContext
      - R9.9: buildStitchPrompt must load {CobblerConfig.Dir}/stitch_context.yaml at invocation time and pass it to buildProjectContext
      - R9.10: The orchestrator must log which context file was loaded or that fallback to Config was used

  R10:
    title: Pre-Cycle Analysis
    items:
      - R10.1: Before each measure/stitch cycle, the orchestrator must run RunPreCycleAnalysis() to produce a combined consistency and code-status snapshot
      - R10.2: RunPreCycleAnalysis must invoke the cross-artifact consistency checker (see prd001 R8) and collect its results into an AnalysisDoc
      - R10.3: RunPreCycleAnalysis must invoke CodeStatus (see prd001 R7) and include the report in the same AnalysisDoc
      - R10.4: RunPreCycleAnalysis must write the AnalysisDoc as YAML to {CobblerConfig.Dir}/analysis.yaml
      - R10.5: loadAnalysisDoc must load {CobblerConfig.Dir}/analysis.yaml and return nil when the file does not exist
      - R10.6: buildProjectContext must include the AnalysisDoc content when analysis.yaml is present so Claude sees current project health in both measure and stitch prompts
      - R10.7: Errors during RunPreCycleAnalysis must be logged and must not block the cycle; the analysis is advisory

non_goals:
  - This PRD does not define the generation lifecycle (see prd002)
  - This PRD does not define the prompt content or Claude behavior expectations
  - This PRD does not define concurrent task execution (tasks run sequentially)

acceptance_criteria:
  - Measure proposes tasks from project state and imports them into beads
  - Stitch executes ready tasks in isolated worktrees and merges results
  - Recovery resets stale tasks and orphaned issues to ready
  - Invocation records are stored on every task with token and LOC data
  - Custom prompt templates override embedded defaults
  - Measure and stitch each read their own context file at invocation time when present
  - Projects without context files use current behavior unchanged
