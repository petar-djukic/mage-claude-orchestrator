# Copyright (c) 2026 Petar Djukic. All rights reserved.
# SPDX-License-Identifier: MIT

id: test-rel01.0
title: Release 01.0 test suite
release: rel01.0
traces:
  - rel01.0-uc001-orchestrator-initialization
  - rel01.0-uc002-generation-lifecycle
  - rel01.0-uc003-measure-workflow
  - rel01.0-uc004-stitch-workflow
  - rel01.0-uc005-resume-recovery
  - rel01.0-uc006-scaffold-operations
  - rel01.0-uc007-build-tooling
  - rel01.0-uc008-performance-benchmarks

tags:
  - unit
  - integration
  - smoke

preconditions:
  - Clean git repository on main branch with no beads directory
  - Go module initialized
  - configuration.yaml present

# ---- uc001: Orchestrator initialization and configuration ----

test_cases:
  - use_case: rel01.0-uc001-orchestrator-initialization
    name: New applies defaults to zero-value Config
    go_test: TestRel01_UC001_NewAppliesDefaults
    inputs:
      command: |
        cfg := orchestrator.DefaultConfig()
    expected:
      state:
        project.binary_dir: "bin"
        generation.prefix: "generation-"
        cobbler.beads_dir: ".beads/"
        cobbler.dir: ".cobbler/"
        project.magefiles_dir: "magefiles"
        claude.secrets_dir: ".secrets"
        claude.default_token_file: "claude.json"

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: New preserves explicitly set Config values
    go_test: TestRel01_UC001_NewPreservesValues
    inputs:
      command: |
        cfg := orchestrator.Config{
          Project:    orchestrator.ProjectConfig{ModulePath: "example.com/test", BinaryName: "mybin", BinaryDir: "out"},
          Generation: orchestrator.GenerationConfig{Prefix: "gen-"},
          Cobbler:    orchestrator.CobblerConfig{BeadsDir: ".issues/"},
        }
        o := orchestrator.New(cfg)
    expected:
      state:
        project.binary_dir: "out"
        generation.prefix: "gen-"
        cobbler.beads_dir: ".issues/"

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: New returns non-nil Orchestrator
    go_test: TestRel01_UC001_NewReturnsNonNil
    inputs:
      command: |
        o := orchestrator.New(orchestrator.Config{
          Project: orchestrator.ProjectConfig{ModulePath: "example.com/test", BinaryName: "test"},
        })
    expected:
      state:
        orchestrator_not_nil: true

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: Init creates beads directory
    go_test: TestRel01_UC001_InitCreatesBD
    inputs:
      command: mage init
    expected:
      exit_code: 0
      state:
        beads_dir_exists: true

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: Init is idempotent
    go_test: TestRel01_UC001_InitIdempotent
    inputs:
      command: |
        mage init
        mage init
    expected:
      exit_code: 0

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: CobblerReset removes cobbler directory
    go_test: TestRel01_UC001_CobblerReset
    inputs:
      command: mage cobbler:reset
    expected:
      exit_code: 0
      state:
        cobbler.dir_exists: false
        beads_dir_exists: true

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: BeadsReset preserves beads directory
    go_test: TestRel01_UC001_BeadsResetKeepsDir
    inputs:
      command: mage beads:reset
    expected:
      exit_code: 0
      state:
        beads_dir_exists: true

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: BeadsReset clears issues
    go_test: TestRel01_UC001_BeadsResetClearsIssues
    inputs:
      command: |
        bd create --type task --title "test"
        mage beads:reset
    expected:
      exit_code: 0
      state:
        ready_issues: 0

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: FullReset clears all orchestrator state
    go_test: TestRel01_UC001_FullResetClearsState
    inputs:
      command: mage reset
    expected:
      exit_code: 0
      state:
        cobbler.dir_exists: false
        generation_branches: 0

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: CobblerReset succeeds when directory missing
    go_test: TestRel01_UC001_CobblerResetWhenMissing
    inputs:
      command: mage cobbler:reset
    expected:
      exit_code: 0

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: BeadsReset succeeds when directory missing
    go_test: TestRel01_UC001_BeadsResetWhenMissing
    inputs:
      command: mage beads:reset
    expected:
      exit_code: 0

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: GeneratorReset succeeds on clean repo
    go_test: TestRel01_UC001_GeneratorResetWhenClean
    inputs:
      command: mage generator:reset
    expected:
      exit_code: 0
      state:
        current_branch: "main"

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: FullReset succeeds from generation branch
    go_test: TestRel01_UC001_FullResetFromGenerationBranch
    inputs:
      command: |
        mage generator:start
        mage reset
    expected:
      exit_code: 0
      state:
        current_branch: "main"
        generation_branches: 0

  - use_case: rel01.0-uc001-orchestrator-initialization
    name: Init succeeds after reset
    go_test: TestRel01_UC001_InitAfterReset
    inputs:
      command: |
        mage reset
        mage init
    expected:
      exit_code: 0
      state:
        beads_dir_exists: true

# ---- uc002: Generation lifecycle from start to stop ----

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorStart creates tagged generation branch
    go_test: TestRel01_UC002_StartCreatesGenBranch
    inputs:
      command: mage generator:start
    expected:
      exit_code: 0
      state:
        current_branch_prefix: "generation-"
        tag_exists_suffix: "-start"
        go_files_deleted: true
        go_mod_exists: true

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorStart fails when not on main
    go_test: TestRel01_UC002_StartFailsWhenNotOnMain
    inputs:
      command: |
        git checkout -b feature
        mage generator:start
    expected:
      exit_code: 1
      stderr_contains: "switching to main"

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorRun executes configured cycles
    go_test: TestRel01_UC002_RunOneCycle
    inputs:
      command: mage generator:run
      config_overrides:
        generation.cycles: 1
        cobbler.max_measure_issues: 1
    expected:
      exit_code: 0
      stdout_contains: "complete, ran 1 cycle(s)"

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorStop merges to main and tags
    go_test: TestRel01_UC002_StopMergesAndTags
    inputs:
      command: mage generator:stop
    expected:
      exit_code: 0
      state:
        current_branch: "main"
        tag_exists_suffix: "-finished"
        tag_exists_suffix_2: "-merged"
        generation_branch_deleted: true

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorList shows all generations
    go_test: TestRel01_UC002_ListShowsMerged
    inputs:
      command: mage generator:list
    expected:
      exit_code: 0
      stdout_contains: "generation-"

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorReset returns to clean main
    go_test: TestRel01_UC002_ResetReturnsToCleanMain
    inputs:
      command: mage generator:reset
    expected:
      exit_code: 0
      state:
        current_branch: "main"
        generation_branches: 0

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorSwitch saves work and changes branch
    go_test: TestRel01_UC002_SwitchSavesAndChangesBranch
    inputs:
      command: |
        mage generator:start
        mage generator:switch
      config_overrides:
        generation.branch: main
    expected:
      exit_code: 0
      state:
        current_branch: "main"

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorRun completes 100 stitch iterations
    go_test: TestRel01_UC002_Stitch100
    inputs:
      command: mage generator:run
      config_overrides:
        cobbler.max_measure_issues: 5
        cobbler.max_stitch_issues: 100
        cobbler.max_stitch_issues_per_cycle: 10
    expected:
      exit_code: 0

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorStop fails when on main with no generation branches
    go_test: TestRel01_UC002_StopFailsWhenOnMain
    inputs:
      command: mage generator:stop
    expected:
      exit_code: 1

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorList shows empty message when no generations exist
    go_test: TestRel01_UC002_ListWhenEmpty
    inputs:
      command: mage generator:list
    expected:
      exit_code: 0
      stdout_contains: "No generations found"

  - use_case: rel01.0-uc002-generation-lifecycle
    name: Start-stop-start creates distinct generation branches
    go_test: TestRel01_UC002_StartStopStartAgain
    inputs:
      command: |
        mage generator:start
        mage generator:stop
        mage generator:start
    expected:
      exit_code: 0
      state:
        second_branch_differs: true

  - use_case: rel01.0-uc002-generation-lifecycle
    name: GeneratorReset works from diverged generation branch
    go_test: TestRel01_UC002_ResetFromGenBranch
    inputs:
      command: |
        mage generator:start
        git add gen-file.txt && git commit -m "generation work"
        mage generator:reset
    expected:
      exit_code: 0
      state:
        current_branch: "main"
        generation_branches: 0

# ---- uc003: Measure workflow task proposal ----

  - use_case: rel01.0-uc003-measure-workflow
    name: Measure queries existing issues
    go_test: TestRel01_UC003_MeasureCreatesIssues
    covered_by: TestRel01_UC003_MeasureCreatesIssues
    inputs:
      command: mage cobbler:measure
      config_overrides:
        cobbler.max_measure_issues: 3
    expected:
      exit_code: 0

  - use_case: rel01.0-uc003-measure-workflow
    name: Measure fails when beads not initialized
    go_test: TestRel01_UC003_MeasureFailsWithoutBeads
    inputs:
      command: |
        rm -rf .beads
        mage cobbler:measure
    expected:
      exit_code: 1
      stderr_contains: "beads not initialized"

  - use_case: rel01.0-uc003-measure-workflow
    name: Measure imports proposed issues into beads
    go_test: TestRel01_UC003_MeasureCreatesIssues
    covered_by: TestRel01_UC003_MeasureCreatesIssues
    inputs:
      command: |
        mage cobbler:measure
        bd list --json
      config_overrides:
        cobbler.max_measure_issues: 3
    expected:
      exit_code: 0
      state:
        issues_created: true

  - use_case: rel01.0-uc003-measure-workflow
    name: Measure respects max_issues limit
    go_test: TestRel01_UC003_MeasureCreatesIssues
    covered_by: TestRel01_UC003_MeasureCreatesIssues
    inputs:
      command: mage cobbler:measure
      config_overrides:
        cobbler.max_measure_issues: 2
    expected:
      exit_code: 0
      state:
        issues_count_lte: 2

  - use_case: rel01.0-uc003-measure-workflow
    name: Measure records InvocationRecord on created issues
    go_test: TestRel01_UC003_MeasureRecordsInvocation
    inputs:
      command: |
        mage cobbler:measure
        bd list --json
      config_overrides:
        cobbler.max_measure_issues: 1
    expected:
      exit_code: 0
      state:
        invocation_record_present: true

  - use_case: rel01.0-uc003-measure-workflow
    name: BeadsReset clears issues after measure
    go_test: TestRel01_UC003_BeadsResetClearsAfterMeasure
    inputs:
      command: |
        mage cobbler:measure
        mage beads:reset
      config_overrides:
        cobbler.max_measure_issues: 1
    expected:
      exit_code: 0
      state:
        ready_issues: 0

  - use_case: rel01.0-uc003-measure-workflow
    name: Measure fails without Claude credentials on main
    go_test: TestRel01_UC003_MeasureFailsWithoutGeneration
    inputs:
      command: mage cobbler:measure
      config_overrides:
        claude.secrets_dir: "/dev/null/impossible"
    expected:
      exit_code: 1

# ---- uc004: Stitch workflow task execution ----

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch picks and executes a ready task
    go_test: TestRel01_UC004_StitchExecutesTask
    inputs:
      command: mage cobbler:stitch
      config_overrides:
        cobbler.max_stitch_issues_per_cycle: 1
    expected:
      exit_code: 0
      state:
        task_closed: true
        task_branch_deleted: true
        worktree_cleaned: true

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch fails when beads not initialized
    go_test: TestRel01_UC004_StitchFailsWithoutBeads
    inputs:
      command: |
        rm -rf .beads
        mage cobbler:stitch
    expected:
      exit_code: 1
      stderr_contains: "beads not initialized"

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch stops when no ready tasks
    go_test: TestRel01_UC004_StitchStopsWhenNoReadyTasks
    inputs:
      command: mage cobbler:stitch
    expected:
      exit_code: 0
      stdout_contains: "completed 0 task(s)"

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch respects max_issues_per_cycle limit
    go_test: TestRel01_UC004_StitchExecutesTask
    covered_by: TestRel01_UC004_StitchExecutesTask
    inputs:
      command: mage cobbler:stitch
      config_overrides:
        cobbler.max_stitch_issues_per_cycle: 2
    expected:
      exit_code: 0
      state:
        tasks_executed_lte: 2

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch creates worktree on task branch
    go_test: TestRel01_UC004_StitchExecutesTask
    covered_by: TestRel01_UC004_StitchExecutesTask
    inputs:
      command: mage cobbler:stitch
      config_overrides:
        cobbler.max_stitch_issues_per_cycle: 1
    expected:
      exit_code: 0
      state:
        task_branch_pattern: "task/{baseBranch}-*"

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch merges task branch back to base
    go_test: TestRel01_UC004_StitchExecutesTask
    covered_by: TestRel01_UC004_StitchExecutesTask
    inputs:
      command: |
        mage cobbler:stitch
        git log --oneline -5
      config_overrides:
        cobbler.max_stitch_issues_per_cycle: 1
    expected:
      exit_code: 0
      stdout_contains: "Merge branch"

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch records InvocationRecord with diff stats
    go_test: TestRel01_UC004_StitchRecordsInvocation
    inputs:
      command: mage cobbler:stitch
      config_overrides:
        cobbler.max_stitch_issues_per_cycle: 1
    expected:
      exit_code: 0
      state:
        invocation_record_has_diff: true
        invocation_record_has_loc: true

  - use_case: rel01.0-uc004-stitch-workflow
    name: Stitch fails without Claude credentials when tasks exist
    go_test: TestRel01_UC004_StitchWithManualIssue
    inputs:
      command: |
        bd create --type task --title "e2e stitch test task"
        mage cobbler:stitch
      config_overrides:
        claude.secrets_dir: "/dev/null/impossible"
    expected:
      exit_code: 1

# ---- uc005: Generation resume and task recovery ----

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume resolves generation branch from configuration
    go_test: TestRel01_UC005_Resume
    covered_by: TestRel01_UC005_Resume
    inputs:
      command: mage generator:resume
      config_overrides:
        generation.branch: generation-2026-01-01-00-00-00
        generation.cycles: 0
    expected:
      exit_code: 0
      state:
        current_branch: "generation-2026-01-01-00-00-00"

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume auto-detects single generation branch
    go_test: TestRel01_UC005_Resume
    covered_by: TestRel01_UC005_Resume
    inputs:
      command: mage generator:resume
      config_overrides:
        generation.cycles: 0
    expected:
      exit_code: 0
      state:
        current_branch_prefix: "generation-"

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume fails with multiple generation branches
    go_test: TestRel01_UC005_ResumeFailsWithMultipleBranches
    inputs:
      command: |
        git branch generation-a
        git branch generation-b
        mage generator:resume
      config_overrides:
        generation.cycles: 0
    expected:
      exit_code: 1
      stderr_contains: "multiple generation branches"

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume recovers stale task branches
    go_test: TestRel01_UC005_ResumeRecoversStaleBranches
    inputs:
      command: |
        git branch task/generation-test-stale-id
        mage generator:resume
      config_overrides:
        generation.cycles: 0
    expected:
      exit_code: 0
      state:
        stale_branch_deleted: true

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume resets orphaned in_progress issues
    go_test: TestRel01_UC005_ResumeResetsOrphanedIssues
    inputs:
      command: mage generator:resume
      config_overrides:
        generation.cycles: 0
    expected:
      exit_code: 0
      state:
        orphaned_issues_reset: true

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume commits work before switching branches
    go_test: TestRel01_UC005_Resume
    covered_by: TestRel01_UC005_Resume
    inputs:
      command: |
        echo "test" > uncommitted.txt
        mage generator:resume
      config_overrides:
        generation.cycles: 0
    expected:
      exit_code: 0
      state:
        uncommitted_work_saved: true

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume drains ready issues before new cycles
    go_test: TestRel01_UC005_Resume
    covered_by: TestRel01_UC005_Resume
    inputs:
      command: mage generator:resume
      config_overrides:
        generation.cycles: 1
        cobbler.max_measure_issues: 1
    expected:
      exit_code: 0

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume fails with zero generation branches
    go_test: TestRel01_UC005_ResumeFailsWithZeroBranches
    inputs:
      command: mage generator:resume
    expected:
      exit_code: 1

  - use_case: rel01.0-uc005-resume-recovery
    name: Resume fails when already on generation branch without credentials
    go_test: TestRel01_UC005_ResumeFailsWhenAlreadyOnGenBranch
    inputs:
      command: |
        mage generator:start
        mage generator:resume
      config_overrides:
        claude.secrets_dir: "/dev/null/impossible"
    expected:
      exit_code: 1

# ---- uc006: Scaffold operations ----

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold writes constitution files
    go_test: TestRel01_UC006_ConstitutionFiles
    inputs:
      command: mage scaffold:push
    expected:
      exit_code: 0
      state:
        constitution_files_exist: true

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold writes prompt files
    go_test: TestRel01_UC006_PromptFiles
    inputs:
      command: mage scaffold:push
    expected:
      exit_code: 0
      state:
        prompt_files_exist: true

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold writes config and magefile
    go_test: TestRel01_UC006_ConfigAndMagefile
    inputs:
      command: mage scaffold:push
    expected:
      exit_code: 0
      state:
        configuration_yaml_exists: true
        orchestrator_go_exists: true

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold rejects self-targeting
    go_test: TestRel01_UC006_RejectSelfTarget
    inputs:
      command: mage scaffold:push .
    expected:
      exit_code: 1
      stderr_contains: "refusing to scaffold"

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold push is idempotent
    go_test: TestRel01_UC006_PushIdempotent
    inputs:
      command: |
        mage scaffold:push /tmp/target
        mage scaffold:push /tmp/target
    expected:
      exit_code: 0

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold pop fails on non-scaffolded directory
    go_test: TestRel01_UC006_PopOnNonScaffolded
    inputs:
      command: mage scaffold:pop /tmp/non-scaffolded
    expected:
      exit_code: 1

  - use_case: rel01.0-uc006-scaffold-operations
    name: Scaffold push/pop round-trip
    go_test: TestRel01_UC006_PushPopRoundTrip
    inputs:
      command: |
        mage scaffold:push /tmp/target
        mage scaffold:pop /tmp/target
    expected:
      exit_code: 0
      state:
        push_files_exist: true
        pop_files_removed: true

# ---- uc007: Build tooling ----

  - use_case: rel01.0-uc007-build-tooling
    name: Build compiles binary
    go_test: TestRel01_UC007_Build
    inputs:
      command: mage build
    expected:
      exit_code: 0
      state:
        binary_exists: true

  - use_case: rel01.0-uc007-build-tooling
    name: Install exits successfully
    go_test: TestRel01_UC007_Install
    inputs:
      command: mage install
    expected:
      exit_code: 0

  - use_case: rel01.0-uc007-build-tooling
    name: Clean removes build artifacts
    go_test: TestRel01_UC007_Clean
    inputs:
      command: |
        mage build
        mage clean
    expected:
      exit_code: 0
      state:
        bin_dir_empty: true

  - use_case: rel01.0-uc007-build-tooling
    name: Stats prints Go LOC
    go_test: TestRel01_UC007_Stats
    inputs:
      command: mage stats
    expected:
      exit_code: 0
      stdout_contains: "go_loc"

  - use_case: rel01.0-uc007-build-tooling
    name: Build skips when no main package present
    go_test: TestRel01_UC007_BuildSkipsWithoutMainPackage
    inputs:
      command: mage build
    expected:
      exit_code: 0
      state:
        binary_exists: false

  - use_case: rel01.0-uc007-build-tooling
    name: Clean succeeds when bin directory does not exist
    go_test: TestRel01_UC007_CleanWhenNoBinDir
    inputs:
      command: mage clean
    expected:
      exit_code: 0

  - use_case: rel01.0-uc007-build-tooling
    name: Analyze runs static analysis
    go_test: TestRel01_UC007_Analyze
    inputs:
      command: mage analyze
    expected:
      exit_code: 0

# ---- uc008: Performance benchmarks ----

  - use_case: rel01.0-uc008-performance-benchmarks
    name: Measure timing varies by issue limit
    go_test: BenchmarkRel01_UC008_MeasureTimingByLimit
    inputs:
      command: go test -bench BenchmarkRel01_UC008_MeasureTimingByLimit -benchtime 1x
      config_overrides:
        cobbler.max_measure_issues: 1..5
    expected:
      exit_code: 0

  - use_case: rel01.0-uc008-performance-benchmarks
    name: Stitch timing varies by cycle count
    go_test: BenchmarkRel01_UC008_StitchTimingByCycle
    inputs:
      command: go test -bench BenchmarkRel01_UC008_StitchTimingByCycle -benchtime 1x
      config_overrides:
        cobbler.max_stitch_issues_per_cycle: 1
    expected:
      exit_code: 0

cleanup:
  - Switch to main branch
  - Delete all generation and task branches
  - Remove worktrees
  - Remove cobbler scratch directory
  - Reset beads
